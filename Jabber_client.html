<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jabber Client Dinamis</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/strophe.js/1.2.16/strophe.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    input, textarea, button {
      margin: 8px 0;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    hr {
      border: 0;
      height: 1px;
      background: #ddd;
      margin: 20px 0;
    }
    #log {
      background-color: #f8f8f8;
      font-family: monospace;
      min-height: 200px;
      white-space: pre-wrap;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .connected { background: #dff0d8; color: #3c763d; }
    .disconnected { background: #f2dede; color: #a94442; }
    .connecting { background: #fcf8e3; color: #8a6d3b; }
    .config-section {
      background: #f0f7ff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Jabber Client Dinamis</h2>
    
    <div class="config-section">
      <h3>Konfigurasi Server</h3>
      <input id="boshEndpoint" type="text" placeholder="BOSH Endpoint (contoh: https://jabber.example.com/http-bind)" value="https://st24.co.id/http-bind">
    </div>
    
    <div class="config-section">
      <h3>Login</h3>
      <input id="jid" type="text" placeholder="JID Anda (contoh: user@domain.com)">
      <input id="pass" type="password" placeholder="Password">
      <button id="loginBtn" onclick="connect()">Login</button>
    </div>
    
    <hr>
    
    <div id="status" class="status disconnected">Status: Tidak terhubung</div>
    
    <textarea id="log" rows="10" readonly></textarea>
    
    <hr>
    
    <div class="config-section">
      <h3>Kirim Pesan</h3>
      <input id="targetJid" type="text" placeholder="JID Tujuan (contoh: penerima@domain.com)" value="xmltronikmantapu77@st24.co.id">
      <input id="msg" placeholder="Isi pesan Anda">
      <button id="sendBtn" onclick="sendMsg()" disabled>Kirim Pesan</button>
    </div>
  </div>

  <script>
    // Variabel global
    let conn = null;
    let isConnected = false;

    // Fungsi untuk menampilkan log
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logElement = document.getElementById("log");
      logElement.value += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
    }

    // Fungsi untuk update tampilan UI
    function updateUI() {
      const loginBtn = document.getElementById('loginBtn');
      const sendBtn = document.getElementById('sendBtn');
      const statusDiv = document.getElementById('status');
      
      if (isConnected) {
        loginBtn.textContent = 'Logout';
        loginBtn.style.backgroundColor = '#d9534f';
        sendBtn.disabled = false;
        statusDiv.textContent = 'Status: Terhubung';
        statusDiv.className = 'status connected';
      } else {
        loginBtn.textContent = 'Login';
        loginBtn.style.backgroundColor = '#4CAF50';
        sendBtn.disabled = true;
        statusDiv.textContent = 'Status: Tidak terhubung';
        statusDiv.className = 'status disconnected';
      }
    }

    // Fungsi untuk koneksi ke server Jabber
    function connect() {
      // Jika sudah terhubung, lakukan disconnect
      if (isConnected) {
        conn.disconnect();
        log("Memutuskan koneksi...");
        isConnected = false;
        updateUI();
        return;
      }

      const jid = document.getElementById("jid").value.trim();
      const pass = document.getElementById("pass").value.trim();
      const boshEndpoint = document.getElementById("boshEndpoint").value.trim();

      // Validasi input
      if (!jid || !pass || !boshEndpoint) {
        log("Error: JID, password, dan BOSH endpoint harus diisi");
        return;
      }

      // Buat koneksi baru
      conn = new Strophe.Connection(boshEndpoint, {
        withCredentials: false
      });
      
      // Update status UI
      document.getElementById('status').textContent = 'Status: Menghubungkan...';
      document.getElementById('status').className = 'status connecting';
      
      log(`Menghubungkan ke ${jid} via ${boshEndpoint}...`);
      
      // Hubungkan ke server
      conn.connect(jid, pass, function(status) {
        if (status === Strophe.Status.CONNECTED) {
          isConnected = true;
          log("‚úÖ Berhasil terhubung ke server Jabber");
          conn.addHandler(onMessage, null, "message", null, null, null);
          conn.send($pres().tree()); // Kirim presence
        } else if (status === Strophe.Status.DISCONNECTED) {
          isConnected = false;
          log("‚ùå Terputus dari server");
        } else if (status === Strophe.Status.AUTHFAIL) {
          isConnected = false;
          log("‚ùå Autentikasi gagal (JID/password salah)");
        } else if (status === Strophe.Status.CONNFAIL) {
          isConnected = false;
          log("‚ùå Gagal terhubung ke server");
        } else if (status === Strophe.Status.ERROR) {
          isConnected = false;
          log("‚ùå Terjadi kesalahan");
        }
        updateUI();
      });
    }

    // Fungsi untuk mengirim pesan
    function sendMsg() {
      if (!isConnected) {
        log("Error: Silakan login terlebih dahulu");
        return;
      }

      const targetJid = document.getElementById("targetJid").value.trim();
      const msg = document.getElementById("msg").value.trim();

      if (!targetJid || !msg) {
        log("Error: JID tujuan dan pesan harus diisi");
        return;
      }

      try {
        const message = $msg({to: targetJid, type: 'chat'}).c("body").t(msg);
        conn.send(message);
        log(`üì§ Mengirim ke ${targetJid}: ${msg}`);
        document.getElementById("msg").value = "";
      } catch (error) {
        log(`‚ùå Gagal mengirim pesan: ${error}`);
      }
    }

    // Handler untuk menerima pesan
    function onMessage(msg) {
      const from = msg.getAttribute("from");
      const body = msg.getElementsByTagName("body")[0];
      if (body) {
        const msgText = Strophe.getText(body);
        log(`üì• Pesan dari ${from}: ${msgText}`);
      }
      return true;
    }

    // Inisialisasi UI saat pertama kali load
    updateUI();
    
    // Info awal
    log("üîµ Aplikasi Jabber Client siap digunakan");
    log("üîµ Silakan isi konfigurasi server dan login");
  </script>
</body>
</html>
